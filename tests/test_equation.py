#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
test_tstoolbox
----------------------------------

Tests for `tstoolbox` module.
"""


from unittest import TestCase
import sys
try:
    from cStringIO import StringIO
except:
    from io import StringIO

import pandas as pd

import tstoolbox


def capture(func, *args, **kwds):
    sys.stdout = StringIO()      # capture output
    out = func(*args, **kwds)
    out = sys.stdout.getvalue()  # release output
    return out


class TestEquation(TestCase):
    def setUp(self):
        dindex = pd.date_range('2000-01-01T00:00:00', periods=24, freq='H')
        self.ats = pd.np.arange(0, 360, 15)
        self.ats = pd.DataFrame(self.ats, index=dindex)

    def test_equation(self):
        out = capture(tstoolbox.equation, 'x*4 + 2', input_ts='tests/test.csv', print_input=True)
        self.assertEqual(out,
"""Datetime, Value, Value_equation
2000-01-01 00:00:00 ,  4.5, 20.0
2000-01-02 00:00:00 ,  4.6, 20.4
""")

    def test_equation_multiple_cols_01(self):
        out = capture(tstoolbox.equation, 'sin(x1)*4 + cos(x2)*2', input_ts='tests/test_multiple_cols.csv', print_input=True)
        self.assertEqual(out,
"""Datetime, Value, Value1, __equation
2000-01-01 00:00:00 ,  4.5, 45.6, -4.00389911875
2000-01-02 00:00:00 ,  4.6, 90.5, -5.61841686236
2000-01-03 00:00:00 ,  4.7, 34.2, -5.87322876716
2000-01-04 00:00:00 ,  4.6, 23.1, -4.86614401542
2000-01-05 00:00:00 ,  4.5, 7.2, -2.6934178416
2000-01-06 00:00:00 ,  4.4, 4.3, -4.60800663972
""")

    def test_equation_multiple_cols_02(self):
        out = capture(tstoolbox.equation, 'x1 + x2', input_ts='tests/test_multiple_cols.csv', print_input=True)
        self.assertEqual(out,
"""Datetime, Value, Value1, __equation
2000-01-01 00:00:00 ,  4.5, 45.6, 50.1
2000-01-02 00:00:00 ,  4.6, 90.5, 95.1
2000-01-03 00:00:00 ,  4.7, 34.2, 38.9
2000-01-04 00:00:00 ,  4.6, 23.1, 27.7
2000-01-05 00:00:00 ,  4.5, 7.2, 11.7
2000-01-06 00:00:00 ,  4.4, 4.3, 8.7
""")

    def test_equation_multiple_cols_03(self):
        out = capture(tstoolbox.equation, 'x1[t] + 0.6*maximum(x1[t-1], x1[t+1]) + x2', input_ts='tests/test_multiple_cols.csv', print_input=True)
        self.assertEqual(out,
"""Datetime, Value, Value1, __equation
2000-01-01 00:00:00 ,  4.5, 45.6,  \n2000-01-02 00:00:00 ,  4.6, 90.5, 97.92
2000-01-03 00:00:00 ,  4.7, 34.2, 41.66
2000-01-04 00:00:00 ,  4.6, 23.1, 30.52
2000-01-05 00:00:00 ,  4.5, 7.2, 14.46
2000-01-06 00:00:00 ,  4.4, 4.3,  \n""")

    def test_equation_multiple_cols_04(self):
        out = capture(tstoolbox.equation, 'x[t] + 0.6*maximum(x[t-1], x[t+1]) + x[t]', input_ts='tests/test_aggregate.csv', print_input=True)
        self.maxDiff = None
        self.assertEqual(out,
"""Datetime, Value, Value_equation
2011-01-01 00:00:00 ,  2.0,  \n2011-01-01 01:00:00 ,  2.0, 5.2
2011-01-01 02:00:00 ,  2.0, 5.2
2011-01-01 03:00:00 ,  2.0, 5.2
2011-01-01 04:00:00 ,  2.0, 5.2
2011-01-01 05:00:00 ,  2.0, 5.2
2011-01-01 06:00:00 ,  2.0, 5.2
2011-01-01 07:00:00 ,  2.0, 5.2
2011-01-01 08:00:00 ,  2.0, 5.2
2011-01-01 09:00:00 ,  2.0, 5.2
2011-01-01 10:00:00 ,  2.0, 5.2
2011-01-01 11:00:00 ,  2.0, 5.2
2011-01-01 12:00:00 ,  2.0, 5.2
2011-01-01 13:00:00 ,  2.0, 5.2
2011-01-01 14:00:00 ,  2.0, 5.2
2011-01-01 15:00:00 ,  2.0, 5.2
2011-01-01 16:00:00 ,  2.0, 5.2
2011-01-01 17:00:00 ,  2.0, 5.2
2011-01-01 18:00:00 ,  2.0, 5.2
2011-01-01 19:00:00 ,  2.0, 5.2
2011-01-01 20:00:00 ,  2.0, 5.2
2011-01-01 21:00:00 ,  2.0, 5.2
2011-01-01 22:00:00 ,  2.0, 5.2
2011-01-01 23:00:00 ,  2.0, 5.2
2011-01-02 00:00:00 ,  2.0, 5.2
2011-01-02 01:00:00 ,  2.0, 5.2
2011-01-02 02:00:00 ,  2.0, 5.2
2011-01-02 03:00:00 ,  2.0, 5.2
2011-01-02 04:00:00 ,  2.0, 5.2
2011-01-02 05:00:00 ,  2.0, 5.2
2011-01-02 06:00:00 ,  2.0, 5.2
2011-01-02 07:00:00 ,  2.0, 5.2
2011-01-02 08:00:00 ,  2.0, 5.2
2011-01-02 09:00:00 ,  2.0, 5.2
2011-01-02 10:00:00 ,  2.0, 5.2
2011-01-02 11:00:00 ,  2.0, 5.2
2011-01-02 12:00:00 ,  2.0, 5.2
2011-01-02 13:00:00 ,  2.0, 5.2
2011-01-02 14:00:00 ,  2.0, 5.2
2011-01-02 15:00:00 ,  2.0, 5.2
2011-01-02 16:00:00 ,  2.0, 5.2
2011-01-02 17:00:00 ,  2.0, 5.2
2011-01-02 18:00:00 ,  2.0, 5.2
2011-01-02 19:00:00 ,  2.0, 5.2
2011-01-02 20:00:00 ,  2.0, 5.2
2011-01-02 21:00:00 ,  2.0, 5.2
2011-01-02 22:00:00 ,  2.0, 5.2
2011-01-02 23:00:00 ,  2.0,  \n""")

    def test_equation_multiple_cols_05(self):
        out = capture(tstoolbox.equation, 'x + 0.6*maximum(x[t-1], x[t+1]) + x[t]', input_ts='tests/test_aggregate.csv', print_input=True)
        self.maxDiff = None
        self.assertEqual(out,
"""Datetime, Value, Value_equation
2011-01-01 00:00:00 ,  2.0,  \n2011-01-01 01:00:00 ,  2.0, 5.2
2011-01-01 02:00:00 ,  2.0, 5.2
2011-01-01 03:00:00 ,  2.0, 5.2
2011-01-01 04:00:00 ,  2.0, 5.2
2011-01-01 05:00:00 ,  2.0, 5.2
2011-01-01 06:00:00 ,  2.0, 5.2
2011-01-01 07:00:00 ,  2.0, 5.2
2011-01-01 08:00:00 ,  2.0, 5.2
2011-01-01 09:00:00 ,  2.0, 5.2
2011-01-01 10:00:00 ,  2.0, 5.2
2011-01-01 11:00:00 ,  2.0, 5.2
2011-01-01 12:00:00 ,  2.0, 5.2
2011-01-01 13:00:00 ,  2.0, 5.2
2011-01-01 14:00:00 ,  2.0, 5.2
2011-01-01 15:00:00 ,  2.0, 5.2
2011-01-01 16:00:00 ,  2.0, 5.2
2011-01-01 17:00:00 ,  2.0, 5.2
2011-01-01 18:00:00 ,  2.0, 5.2
2011-01-01 19:00:00 ,  2.0, 5.2
2011-01-01 20:00:00 ,  2.0, 5.2
2011-01-01 21:00:00 ,  2.0, 5.2
2011-01-01 22:00:00 ,  2.0, 5.2
2011-01-01 23:00:00 ,  2.0, 5.2
2011-01-02 00:00:00 ,  2.0, 5.2
2011-01-02 01:00:00 ,  2.0, 5.2
2011-01-02 02:00:00 ,  2.0, 5.2
2011-01-02 03:00:00 ,  2.0, 5.2
2011-01-02 04:00:00 ,  2.0, 5.2
2011-01-02 05:00:00 ,  2.0, 5.2
2011-01-02 06:00:00 ,  2.0, 5.2
2011-01-02 07:00:00 ,  2.0, 5.2
2011-01-02 08:00:00 ,  2.0, 5.2
2011-01-02 09:00:00 ,  2.0, 5.2
2011-01-02 10:00:00 ,  2.0, 5.2
2011-01-02 11:00:00 ,  2.0, 5.2
2011-01-02 12:00:00 ,  2.0, 5.2
2011-01-02 13:00:00 ,  2.0, 5.2
2011-01-02 14:00:00 ,  2.0, 5.2
2011-01-02 15:00:00 ,  2.0, 5.2
2011-01-02 16:00:00 ,  2.0, 5.2
2011-01-02 17:00:00 ,  2.0, 5.2
2011-01-02 18:00:00 ,  2.0, 5.2
2011-01-02 19:00:00 ,  2.0, 5.2
2011-01-02 20:00:00 ,  2.0, 5.2
2011-01-02 21:00:00 ,  2.0, 5.2
2011-01-02 22:00:00 ,  2.0, 5.2
2011-01-02 23:00:00 ,  2.0,  \n""")
